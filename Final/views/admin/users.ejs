<!DOCTYPE html>
<html>
  <%- include('../components/headTag.ejs') %>
  <body>
    <%- include('./components/header.ejs') %> <%-
    include('./components/navbar.ejs') %>
    <div class="mobile-menu-overlay"></div>

    <div
      class="modal fade"
      id="exampleModal"
      tabindex="-1"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Add User</h5>
            <button
              type="button"
              class="btn-close border-0 bg-transparent"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="addUserForm">
              <div class="row">
                <div class="mb-3 col-6">
                  <label for="firstName" class="form-label"
                    >First Name<span class="text-danger">* </span></label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="firstName"
                    name="firstName"
                    placeholder="Enter first name"
                  />
                </div>
                <div class="mb-3 col-6">
                  <label for="lastName" class="form-label"
                    >Last Name<span class="text-danger">* </span></label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="lastName"
                    name="lastName"
                    placeholder="Enter last name"
                  />
                </div>
              </div>

              <div class="mb-3">
                <label for="email" class="form-label"
                  >Email <span class="text-danger">* </span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="email"
                  name="email"
                  placeholder="Enter email"
                />
              </div>
              <div class="mb-3">
                <label for="password" class="form-label"
                  >Password <span class="text-danger">* </span></label
                >
                <input
                  type="password"
                  class="form-control"
                  id="password"
                  name="password"
                  placeholder="Enter password"
                />
              </div>
              <div class="mb-3">
                <label for="role" class="form-label">Role</label>
                <select class="form-control" id="role" name="role">
                  <option value="user">User</option>
                  <option value="admin">Admin</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="points" class="form-label">Points</label>
                <input
                  type="number"
                  class="form-control"
                  id="points"
                  name="points"
                  placeholder="Enter points (optional)"
                  min="0"
                  value="0"
                />
              </div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Close
                </button>
                <button type="submit" class="btn btn-primary">Add</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="main-container">
      <div class="mb-20 d-flex justify-content-between p-3">
        <h1>Users</h1>
        <button
          type="button"
          class="btn btn-success"
          data-bs-toggle="modal"
          data-bs-target="#exampleModal"
        >
          + Add User
        </button>
      </div>
      <div class="card-box mb-30">
        <div class="pb-20 pt-20">
          <table class="data-table table hover nowrap">
            <thead>
              <tr>
                <th class="table-plus datatable-nosort">Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>points</th>
                <th class="datatable-nosort">Action</th>
              </tr>
            </thead>
            <tbody>
              <% users.forEach(u => { %>
              <tr id="user-<%= u._id %>">
                <td class="table-plus"><%= u.firstName %> <%= u.lastName %></td>
                <td><%= u.email %></td>
                <td><%= u.role %></td>
                <td><%= u.points %></td>
                <td>
                  <div class="dropdown">
                    <a
                      class="btn btn-link font-24 p-0 line-height-1 no-arrow dropdown-toggle"
                      href="#"
                      role="button"
                      data-toggle="dropdown"
                    >
                      <i class="dw dw-more"></i>
                    </a>
                    <div
                      class="dropdown-menu dropdown-menu-right dropdown-menu-icon-list"
                    >
                      <a class="dropdown-item" href="/admin/edit-users/<%=u._id%>">
                        <i class="dw dw-edit2"></i> Edit
                      </a>
                      <button
                        class="dropdown-item text-danger delete-button"
                        data-id="<%= u._id %>"
                      >
                        <i
                          class="icon-copy fa fa-trash-o"
                          aria-hidden="true"
                        ></i
                        >Delete
                      </button>
                    </div>
                  </div>
                </td>
              </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- js -->
    <script src="/vendors/scripts/core.js"></script>
    <script src="/vendors/scripts/script.min.js"></script>
    <script src="/vendors/scripts/process.js"></script>
    <script src="/vendors/scripts/layout-settings.js"></script>
    <script src="/plugins/datatables/js/jquery.dataTables.min.js"></script>
    <script src="/plugins/datatables/js/dataTables.bootstrap4.min.js"></script>
    <script src="/plugins/datatables/js/dataTables.responsive.min.js"></script>
    <script src="/plugins/datatables/js/responsive.bootstrap4.min.js"></script>
    <script src="/plugins/datatables/js/dataTables.buttons.min.js"></script>
    <script src="/plugins/datatables/js/buttons.bootstrap4.min.js"></script>
    <script src="/plugins/datatables/js/buttons.print.min.js"></script>
    <script src="/plugins/datatables/js/buttons.html5.min.js"></script>
    <script src="/plugins/datatables/js/buttons.flash.min.js"></script>
    <script src="/plugins/datatables/js/pdfmake.min.js"></script>
    <script src="/plugins/datatables/js/vfs_fonts.js"></script>
    <script src="/vendors/scripts/datatable-setting.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/validator@13.7.0/validator.min.js"></script>

    <script type="module">
      import showMsg from "/js/toastify.js";

      document
        .getElementById("addUserForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault();

          // Collecting form data
          const firstName = document.getElementById("firstName").value;
          const lastName = document.getElementById("lastName").value;
          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;
          const role = document.getElementById("role").value;
          const points = document.getElementById("points").value;

          let valid = true;

          // Validation checks
          if (!firstName.trim()) {
            valid = false;
            return showMsg("First Name is required.", "red");
          }

          if (!lastName.trim()) {
            valid = false;
            return showMsg("Last Name is required.", "red");
          }

          if (!email.trim() || !/\S+@\S+\.\S+/.test(email)) {
            valid = false;
            return showMsg("Please enter a valid email address.", "red");
          }

          if (!password.trim()) {
            valid = false;
            return showMsg("Password is required.", "red");
          }

          try {
            if (valid) {
              const response = await fetch("/users", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  firstName,
                  lastName,
                  email,
                  password,
                  confirmPassword: password,
                  role,
                  points,
                }),
              });

              const data = await response.json();

              if (response.ok) {
                showMsg("User added successfully!", "green");
                setTimeout(() => {
                  window.location.reload();
                }, 500);
              } else {
                showMsg(data.error || "Something went wrong.", "red");
              }
            }
          } catch (error) {
            showMsg("An error occurred: " + error.message, "red");
          }
        });
    </script>

    <script type="module">
      import showMsg from "/js/toastify.js";
      document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".delete-button").forEach((button) => {
          button.addEventListener("click", async (event) => {
            const userId = event.target.getAttribute("data-id");

            const response = await fetch(`/users/${userId}`, {
              method: "DELETE",
            });

            if (response.ok) {
              document.getElementById(`user-${userId}`).remove();
              showMsg("User deleted successfully", "green");
            } else {
              showMsg("Failed to delete user", "red");
            }
          });
        });
      });
    </script>
  </body>
</html>
